<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 Sweat Sensor Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for plotting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Inter Font -->
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f7f9fb;
      }
      .card {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.06);
      }

      /* Toggle Switch Custom Styles */
      .toggle-checkbox:checked {
        right: 0;
        border-color: #4f46e5;
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: #4f46e5;
      }

      /* LED Animation */
      .led-glow-green {
        box-shadow: 0 0 10px #22c55e, 0 0 20px #22c55e inset;
      }
      .led-glow-red {
        box-shadow: 0 0 10px #ef4444, 0 0 20px #ef4444 inset;
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-extrabold text-gray-800 mb-2 text-center">
        Sweat Sensor Data Logger (ESP32-S3)
      </h1>
      <p class="text-center text-gray-600 mb-8">
        Connect via USB or Bluetooth to start logging.
      </p>

      <!-- Power & Connection Controls -->
      <div class="card bg-white p-6 rounded-xl border border-indigo-100 mb-6">
        <div
          class="flex flex-col md:flex-row justify-between items-center gap-6"
        >
          <!-- Power Switch Section -->
          <div class="flex items-center gap-4">
            <div
              class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"
            >
              <input
                type="checkbox"
                name="toggle"
                id="power-switch"
                class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 transition-all duration-300 left-0"
              />
              <label
                for="power-switch"
                class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"
              ></label>
            </div>
            <span class="font-bold text-gray-700">Battery Power</span>

            <!-- Status LED -->
            <div
              class="flex items-center gap-2 ml-4 px-3 py-1 rounded-full bg-gray-50 border border-gray-200"
            >
              <span class="text-xs font-semibold text-gray-500 uppercase"
                >Status</span
              >
              <div
                id="status-led"
                class="w-4 h-4 rounded-full bg-gray-300 transition-all duration-300"
              ></div>
            </div>
          </div>

          <!-- Hardware Buttons -->
          <div
            id="connection-buttons"
            class="flex gap-3 opacity-50 pointer-events-none transition-opacity duration-300"
          >
            <button
              id="btn-usb"
              class="flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
                ></path>
                <path
                  d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
                ></path>
              </svg>
              USB
            </button>

            <button
              id="btn-ble"
              class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M7 7l10 10-5 5V2l5 5L7 17"></path>
              </svg>
              BLE
            </button>
          </div>
        </div>
      </div>

      <!-- Current Value and Status Card -->
      <div id="data-display" class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
        <div class="card bg-white p-6 rounded-xl border border-blue-200">
          <p class="text-sm font-medium text-gray-500">Current Voltage</p>
          <p id="current-voltage" class="text-3xl font-bold text-blue-600 mt-1">
            -- V
          </p>
        </div>
        <div class="card bg-white p-6 rounded-xl border border-gray-200">
          <p class="text-sm font-medium text-gray-500">Raw ADC Value</p>
          <p id="current-raw" class="text-3xl font-bold text-gray-800 mt-1">
            ----
          </p>
        </div>
        <div class="card bg-white p-6 rounded-xl border border-green-200">
          <p class="text-sm font-medium text-gray-500">System Log</p>
          <p id="status-message" class="text-sm font-bold text-gray-400 mt-3">
            Power Off
          </p>
        </div>
      </div>

      <!-- Chart and Controls -->
      <div class="card bg-white p-6 rounded-xl">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">
          Live Voltage Trend
        </h2>
        <div class="h-64 mb-6">
          <canvas id="voltageChart"></canvas>
        </div>

        <div
          class="flex flex-col sm:flex-row justify-between items-center gap-4"
        >
          <button
            id="export-csv-btn"
            class="w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150 disabled:opacity-50"
            disabled
          >
            <span id="export-text">Export All Data to CSV</span>
          </button>
        </div>
      </div>

      <!-- Error Message Box -->
      <div
        id="error-box"
        class="hidden mt-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md"
        role="alert"
      >
        <p class="font-bold">Error</p>
        <p id="error-message"></p>
      </div>
    </div>

    <script type="module">
      // --- Configuration ---
      const MAX_ADC_VALUE = 4095.0;
      const MAX_ATTENUATION_VOLTAGE = 1.25;

      // BLE UUIDs
      const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
      const CHARACTERISTIC_UUID_RX = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

      // --- DOM Elements ---
      const STATUS_EL = document.getElementById("status-message");
      const VOLTAGE_EL = document.getElementById("current-voltage");
      const RAW_EL = document.getElementById("current-raw");
      const EXPORT_BTN = document.getElementById("export-csv-btn");
      const ERROR_BOX = document.getElementById("error-box");
      const ERROR_MESSAGE_EL = document.getElementById("error-message");

      const BTN_USB = document.getElementById("btn-usb");
      const BTN_BLE = document.getElementById("btn-ble");

      const POWER_SWITCH = document.getElementById("power-switch");
      const STATUS_LED = document.getElementById("status-led");
      const CONN_BTNS_CONTAINER = document.getElementById("connection-buttons");

      // --- Global State ---
      let chartInstance;
      let dataHistory = [];
      let isHardwareConnected = false;

      // USB Serial Port
      let port;
      let reader;
      let readableStreamClosed;
      let textDecoderStream;

      // Bluetooth Device
      let bluetoothDevice;
      let gattServer;

      // --- Utility Functions ---
      function displayError(message) {
        ERROR_MESSAGE_EL.textContent = message;
        ERROR_BOX.classList.remove("hidden");
        setTimeout(() => ERROR_BOX.classList.add("hidden"), 5000);
        console.error(message);
      }

      function updateStatus(msg, type = "neutral") {
        STATUS_EL.textContent = msg;
        STATUS_EL.className =
          "text-sm font-bold mt-3 " +
          (type === "success"
            ? "text-green-600"
            : type === "error"
            ? "text-red-600"
            : "text-gray-600");
      }

      function setLedState(state) {
        STATUS_LED.className =
          "w-4 h-4 rounded-full transition-all duration-300 ";
        if (state === "off") {
          STATUS_LED.classList.add("bg-gray-300");
        } else if (state === "standby") {
          STATUS_LED.classList.add("bg-red-500", "led-glow-red");
        } else if (state === "active") {
          STATUS_LED.classList.add("bg-green-500", "led-glow-green");
        }
      }

      // --- Power Switch Logic ---
      function handlePowerToggle() {
        if (POWER_SWITCH.checked) {
          // Power ON
          CONN_BTNS_CONTAINER.classList.remove(
            "opacity-50",
            "pointer-events-none"
          );
          setLedState("standby");
          updateStatus("System On. Ready to connect.", "neutral");
        } else {
          // Power OFF
          disconnectHardware(); // Force disconnect
          CONN_BTNS_CONTAINER.classList.add(
            "opacity-50",
            "pointer-events-none"
          );
          setLedState("off");
          updateStatus("Power Off", "neutral");
          VOLTAGE_EL.textContent = "-- V";
          RAW_EL.textContent = "----";
        }
      }

      async function disconnectHardware() {
        isHardwareConnected = false;

        // Disconnect BLE
        if (gattServer && gattServer.connected) {
          bluetoothDevice.gatt.disconnect();
        }

        // Disconnect USB (Best effort, Serial API locking is complex)
        if (reader) {
          await reader.cancel();
          reader.releaseLock();
          reader = null;
        }
        if (port) {
          await port.close();
          port = null;
        }
      }

      // --- Chart Functions ---
      function initChart() {
        const ctx = document.getElementById("voltageChart").getContext("2d");
        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Voltage (V)",
                data: [],
                borderColor: "#2563EB",
                backgroundColor: "rgba(37, 99, 235, 0.2)",
                borderWidth: 2,
                pointRadius: 3,
                tension: 0.2,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                type: "category",
                ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
              },
              y: { min: 0, max: 1.3 },
            },
            plugins: { legend: { display: false } },
          },
        });
      }

      function addDataPoint(raw, voltage) {
        if (!POWER_SWITCH.checked) return; // Don't log if power is off

        const timestamp = new Date();
        const newData = {
          timestamp: timestamp.getTime(),
          raw: raw,
          voltage: voltage,
        };

        dataHistory.push(newData);

        // Update UI Text
        VOLTAGE_EL.textContent = `${voltage.toFixed(4)} V`;
        RAW_EL.textContent = raw;
        EXPORT_BTN.disabled = false;

        // Update Chart
        const label = timestamp.toLocaleTimeString();
        const chartDataLimit = 50;

        if (chartInstance.data.labels.length > chartDataLimit) {
          chartInstance.data.labels.shift();
          chartInstance.data.datasets[0].data.shift();
        }

        chartInstance.data.labels.push(label);
        chartInstance.data.datasets[0].data.push(voltage);
        chartInstance.update("none");
      }

      function switchToHardwareMode(modeName) {
        isHardwareConnected = true;
        updateStatus(`Connected via ${modeName}`, "success");
        setLedState("active"); // Green LED
      }

      // --- USB (Web Serial) Connection ---
      async function connectUSB() {
        if (!navigator.serial) {
          displayError("Web Serial API not supported (Use Chrome/Edge).");
          return;
        }

        try {
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 });

          switchToHardwareMode("USB");

          textDecoderStream = new TextDecoderStream();
          readableStreamClosed = port.readable.pipeTo(
            textDecoderStream.writable
          );
          reader = textDecoderStream.readable.getReader();

          let buffer = "";

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            if (POWER_SWITCH.checked) {
              buffer += value;
              const lines = buffer.split("\n");
              buffer = lines.pop();

              for (const line of lines) {
                if (line.trim().startsWith("{")) {
                  try {
                    const data = JSON.parse(line);
                    if (data.voltage !== undefined) {
                      addDataPoint(data.raw, data.voltage);
                    }
                  } catch (e) {}
                }
              }
            }
          }
        } catch (error) {
          displayError(`USB Error: ${error}`);
          isHardwareConnected = false;
          if (POWER_SWITCH.checked) setLedState("standby");
        }
      }

      // --- Bluetooth (Web Bluetooth) Connection ---
      async function connectBLE() {
        if (!navigator.bluetooth) {
          displayError("Web Bluetooth API not supported (Use Chrome/Edge).");
          return;
        }

        try {
          updateStatus("Scanning...", "neutral");

          bluetoothDevice = await navigator.bluetooth.requestDevice({
            filters: [{ name: "ESP32_Sweat_Sensor" }],
            optionalServices: [SERVICE_UUID],
          });

          bluetoothDevice.addEventListener(
            "gattserverdisconnected",
            onDisconnected
          );

          gattServer = await bluetoothDevice.gatt.connect();
          const service = await gattServer.getPrimaryService(SERVICE_UUID);
          const characteristic = await service.getCharacteristic(
            CHARACTERISTIC_UUID_RX
          );

          await characteristic.startNotifications();
          characteristic.addEventListener(
            "characteristicvaluechanged",
            handleBLEData
          );

          switchToHardwareMode("Bluetooth");
        } catch (error) {
          displayError(`BLE Error: ${error}`);
          updateStatus("Connection Failed", "error");
        }
      }

      function handleBLEData(event) {
        if (!POWER_SWITCH.checked) return;

        const value = event.target.value;
        const decoder = new TextDecoder("utf-8");
        const line = decoder.decode(value);

        try {
          const data = JSON.parse(line);
          if (data.voltage !== undefined) {
            addDataPoint(data.raw, data.voltage);
          }
        } catch (e) {}
      }

      function onDisconnected() {
        updateStatus("Device Disconnected", "error");
        isHardwareConnected = false;
        if (POWER_SWITCH.checked) setLedState("standby");
      }

      // --- CSV Export ---
      function exportCSV() {
        if (dataHistory.length === 0) {
          alert("No data to export.");
          return;
        }
        const csvContent = [
          ["Timestamp", "Raw ADC", "Voltage (V)"],
          ...dataHistory.map((item) => [
            new Date(item.timestamp).toISOString(),
            item.raw,
            item.voltage,
          ]),
        ]
          .map((e) => e.join(","))
          .join("\n");

        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `sweat_data_${new Date()
          .toISOString()
          .slice(0, 10)}.csv`;
        link.click();
      }

      // --- Event Listeners ---
      document.addEventListener("DOMContentLoaded", () => {
        initChart();

        // Initialize Switch State
        POWER_SWITCH.checked = false;
        handlePowerToggle(); // Apply initial state

        POWER_SWITCH.addEventListener("change", handlePowerToggle);
        BTN_USB.addEventListener("click", connectUSB);
        BTN_BLE.addEventListener("click", connectBLE);
        EXPORT_BTN.addEventListener("click", exportCSV);
      });
    </script>
  </body>
</html>
